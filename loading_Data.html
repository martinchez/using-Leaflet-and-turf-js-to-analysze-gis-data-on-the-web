<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--leaflet-->
    <link rel="stylesheet" href="src/leaflet.css" />
    <script src="src/leaflet.js"></script>

    <link rel="stylesheet" href="src/css/bootstrap.css" />
    <script src="src/jquery-3.2.0.min.js"></script>

    <link rel="stylesheet" href="src/plugins/L.Control.Pan.css" />
    <script src="src/plugins/L.Control.Pan.js"></script>

    <link rel="stylesheet" href="src/plugins/L.Control.Zoomslider.css" />
    <script src="src/plugins/L.Control.Zoomslider.js"></script>

    <link rel="stylesheet" href="src/plugins/L.Control.MousePosition.css" />
    <script src="src/plugins/L.Control.MousePosition.js"></script>

    <link rel="stylesheet" href="src/plugins/Leaflet.PolylineMeasure.css" />
    <script src="src/plugins/Leaflet.PolylineMeasure.js"></script>

    <link rel="stylesheet" href="src/plugins/easy-button.css" />
    <script src="src/plugins/easy-button.js"></script>

    <link rel="stylesheet" href="src/plugins/L.Control.Sidebar.css" />
    <script src="src/plugins/L.Control.Sidebar.js"></script>

    <link rel="stylesheet" href="src/plugins/opencage/src/css/L.Control.OpenCageSearch.css" />
    <script src="src/plugins/opencage/src/js/L.Control.OpenCageSearch.js"></script>

    <link rel="stylesheet" href="src/plugins/leaflet-styleeditor/css/Leaflet.StyleEditor.css" />
    <script src="src/plugins/leaflet-styleeditor/javascript/Leaflet.StyleEditor.js"></script>
    <script src="src/plugins/leaflet-styleeditor/javascript/Leaflet.StyleForms.js"></script>

    <script src="src/plugins/leaflet-providers.js"></script>

    <!--    ***************  Begin Leaflet.Draw-->

    <script src="src/plugins/leaflet-draw/Leaflet.draw.js"></script>
    <script src="src/plugins/leaflet-draw/Leaflet.Draw.Event.js"></script>
    <link rel="stylesheet" href="src/plugins/leaflet-draw/leaflet.draw.css" />

    <script src="src/plugins/leaflet-draw/Toolbar.js"></script>
    <script src="src/plugins/leaflet-draw/Tooltip.js"></script>

    <script src="src/plugins/leaflet-draw/ext/GeometryUtil.js"></script>
    <script src="src/plugins/leaflet-draw/ext/LatLngUtil.js"></script>
    <script src="src/plugins/leaflet-draw/ext/LineUtil.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/ext/Polygon.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/ext/Polyline.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/ext/TouchEvents.js"></script>

    <script src="src/plugins/leaflet-draw/draw/DrawToolbar.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Feature.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.SimpleShape.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Polyline.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Circle.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Marker.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Polygon.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Rectangle.js"></script>

    <script src="src/plugins/leaflet-draw/edit/EditToolbar.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/EditToolbar.Edit.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/EditToolbar.Delete.js"></script>

    <script src="src/plugins/leaflet-draw/Control.Draw.js"></script>

    <script src="src/plugins/leaflet-draw/edit/handler/Edit.Poly.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/Edit.SimpleShape.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/Edit.Circle.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/Edit.Rectangle.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/Edit.Marker.js"></script>

    <!--    **************  End of Lealet Draw-->

    <script src="src/plugins/leaflet.ajax.min.js"></script>
    <!--Leaflet sprite plugin-->
    <script src="src/plugins/leaflet.sprite.js"></script>

    <!-- Font awsome -->
    <link rel="stylesheet" href="src/css/font-awesome.min.css">

    <!-- fontawsome leaflet plugin -->
    <!-- <link rel="stylesheet" href="src/plugins/leaflet.awesome-markers.css">
    <script src="src/plugins/leaflet.awesome-markers.min.js"></script>

    leaflet mapkey plugin -->
    <!-- <link rel="stylesheet" href="src/plugins/leaflet-mapkey/MapkeyIcons.css">
    <link rel="stylesheet" href="src/plugins/leaflet-mapkey/L.Icon.Mapkey.css">
    <script src="src/plugins/leaflet-mapkey/L.Icon.Mapkey.js"></script> -->
    <!-- leaflets marker control -->
    <link rel="stylesheet" href="src/plugins/MarkerCluster.css">
    <link rel="stylesheet" href="src/plugins/MarkerCluster.Default.css">
    <script src="src/plugins/leaflet.markercluster.js"></script>
    <style>
        #mapdiv {
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="side-bar" class="col-md-3">
        <button id="btnLocate" class="btn btn-primary btn-block">Locate</button>
    </div>
    <div id="mapdiv" class="col-md-12"></div>
    <script>
        var mymap;
        var lyrOSM;
        var lyrWatercolor;
        var lyrTopo;
        var lyrImagery;
        var lyrOutdoors;
        var lyrEagleNests;
        var lyrRaptorNests;
        var lyrMarkerCluster;
        var lyrClientLines;
        var lyrGBH
        var lyrBOUWEL;
        var mrkCurrentLocation;
        var fgpDrawnItems;
        var ctlAttribute;
        var ctlScale;
        var ctlPan;
        var ctlMouseposition;
        var ctlMeasure;
        var ctlEasybutton;
        var ctlSidebar;
        var ctlSearch;
        var ctlLayers;
        var ctlDraw;
        var ctlStyle;
        var objBasemaps;
        var objOverlays;
        // var icnRedSprite
        // var icnVioletSprite
        // var icnLAMtree
        // var icnLAMbird
        // var icnLMKtree
        // var icnLMKbird
        // var icnEagleInactive
        // var icnEagleActive


        $(document).ready(function () {
            //defining the sprite colors
            // icnRedSprite=L.spriteIcon("red")
            // icnVioletSprite=L.spriteIcon("violet")

            // // defining fontawsomeleaflet icons
            // icnLAMtree=L.AwesomeMarkers.icon({icon:'tree-conifer',markerColor:'green'})
            // icnLAMbird=L.AwesomeMarkers.icon({icon:'twitter',spin:true,iconColor:'#ff0000',markerColor:'green',prefix:'fa'})

            // //defining mapkey icons
            // icnLMKtree=L.icon.mapkey({icon:"bar",color:'#725139',background:'purple',size:30})
            // icnLMKbird=L.icon.mapkey({icon:"school",color:'#725139',background:'red',size:50,borderRadius:18})

            // defining a custom icon
            // icnEagleInactive=L.icon({iconUrl:'img/nest.png',iconSize:[40,40],iconAnchor:[20,24]})
            // icnEagleActive=L.icon({iconUrl:'img/nest2.png',iconSize:[40,40],iconAnchor:[20,24]})

            mymap = L.map("mapdiv", {
                center: [19.4, -99.2],
                zoom: 9,
                zoomControl: false,
                attributionControl: false,
            });
            lyrOSM = L.tileLayer.provider("OpenStreetMap.Mapnik");
            lyrTopo = L.tileLayer.provider("OpenTopoMap");
            lyrImagery = L.tileLayer.provider("Esri.WorldImagery");
            lyrOutdoors = L.tileLayer.provider("Thunderforest.Outdoors");
            lyrWatercolor = L.tileLayer.provider("Stamen.Watercolor");
            mymap.addLayer(lyrOSM);

            objBasemaps = {
                "Open Street Maps": lyrOSM,
                "Topo Map": lyrTopo,
                Imagery: lyrImagery,
                Outdoors: lyrOutdoors,
                Watercolor: lyrWatercolor,
            };

            ///////////////////////eFeatures That are added////////////////
            fgpDrawnItems = new L.featureGroup().addTo(mymap);

            ///////////////////////eagle Layer////////////////
            lyrEagleNests = L.geoJSON.ajax('data/wildlife_eagle.geojson',
                { pointToLayer: returnEaglrMarker }
            ).addTo(mymap);
            lyrEagleNests.on('data:loaded', function () {
                mymap.fitBounds(lyrEagleNests.getBounds());
            })

            //////////////////////////Marker cluster control//////////////////////////////////
            lyrMarkerCluster = L.markerClusterGroup();
            //////////////////////////raptor Layer//////////////////////////////////
            lyrRaptorNests = L.geoJSON.ajax('data/wildlife_raptor.geojson',
                { pointToLayer: returnRaptorMarker }
            );
            //getting the bounds of the datacet of eaglenest and setting the map to those bounds
            lyrRaptorNests.on('data:loaded', function () {
                lyrMarkerCluster.addLayer(lyrRaptorNests);
                lyrMarkerCluster.addTo(mymap)
            })
            // 
            lyrClientLines = L.geoJSON.ajax('data/client_lines.geojson',
                { style: styleClientLine, onEachFeature: processClientLinears }
            ).addTo(mymap)

            lyrBOUWEL = L.geoJSON.ajax('data/wildlife_buowl.geojson',
                { style: styleBOUWL, onEachFeature: processBOUWL, filter: filterBOUWL }
            ).addTo(mymap)
            lyrGBH = L.geoJSON.ajax('data/wildlife_gbh.geojson',
                { style: { color: 'fuchsia' } }
            ).bindTooltip("GBH nesting area").addTo(mymap);
            ///////////////////////Layer Control////////////////
            objOverlays = {
                "Drawn Items": fgpDrawnItems,
                "Nest Data": lyrEagleNests,
                "Raptor Nests": lyrMarkerCluster,
                "Client Line": lyrClientLines,
                "Burrowing": lyrBOUWEL,
                "GBH DATA": lyrGBH
            };


            ctlLayers = L.control.layers(objBasemaps, objOverlays).addTo(mymap);

            ctlMeasure = L.control
                .polylineMeasure({ showBearings: true, showClearControl: true })
                .addTo(mymap);
            ctlStyle = L.control
                .styleEditor({
                    position: "topright",
                })
                .addTo(mymap);
            ctlDraw = new L.Control.Draw({
                draw: {
                    circle: false,
                },
                edit: {
                    featureGroup: fgpDrawnItems,
                },
            }).addTo(mymap);

            mymap.on("draw:created", function (e) {
                console.log(e);
                fgpDrawnItems.addLayer(e.layer);
            });
            ctlSidebar = L.control.sidebar("side-bar").addTo(mymap);

            ctlEasybutton = L.easyButton("glyphicon-triangle-right", function () {
                ctlSidebar.show();
            }).addTo(mymap);
            ctlEasybutton = L.easyButton("glyphicon-triangle-left", function () {
                ctlSidebar.hide();
            }).addTo(mymap);

            ctlAttribute = L.control
                .attribution({ position: "bottomleft" })
                .addTo(mymap);
            ctlAttribute.addAttribution("OSM");
            ctlAttribute.addAttribution(
                '&copy; <a href="http://servdev.co.ke">servdev Solutions</a>'
            );

            ctlScale = L.control
                .scale({ position: "bottomleft", metric: false, maxWidth: 200 })
                .addTo(mymap);
            ctlMouseposition = L.control.mousePosition().addTo(mymap);

            mymap.on("contextmenu", function (e) {
                var dtCurrentTime = new Date();
                L.marker(e.latlng)
                    .addTo(mymap)
                    .bindPopup(e.latlng.toString() + "<br>" + dtCurrentTime.toString());
            });

            mymap.on("locationfound", function (e) {
                console.log(e);
                if (mrkCurrentLocation) {
                    mrkCurrentLocation.remove();
                }
                mrkCurrentLocation = L.circle(e.latlng, {
                    radius: e.accuracy / 2,
                }).addTo(mymap);
                mymap.setView(e.latlng, 14);
            });

            mymap.on("locationerror", function (e) {
                console.log(e);
                alert("Location was not found");
            });


            $("#btnLocate").click(function () {
                mymap.locate();
            });
        });

        function LatLngToArrayString(ll) {
            //                console.log(ll);
            return "[" + ll.lat.toFixed(5) + ", " + ll.lng.toFixed(5) + "]";
        }
        function returnEaglrMarker(json, latlng) {
            var att = json.properties;
            if (att.status == 'ACTIVE NEST') {
                var clrNest = 'deeppink'
                // var wgtNest=7;
                // var opcNest=1;
                // var clrNest='deepgreen';
                // var dashNest='';
            } else {
                var clrNest = 'green'
                //bellow are other variable we can use to style the symbols appearing on the map
                //   var wgtNest=7;
                //   var opcNest=1;
                //   var clrNest='lightgreen';
                //   var dashNest='1,8';
            }
            return L.circle(latlng, { radius: 804, color: clrNest, fillColor: 'green', fillOpacity: 0.5 }).bindTooltip("<h4>Eagle Nest: " + att.nest_id + "</h4>status:" + att.status)
            // if (att.status=='ACTIVE NEST') {
            //     var incEagle=icnEagleActive;
            // }else{
            //     var incEagle = icnEagleInactive;
            // }
            // return L.marker(latlng, {icon:incEagle}).bindTooltip("<h4>Eagle Nest: " + att.nest_id + "</h4>status:" + att.status)
        }
        function returnRaptorMarker(json, latlng) {
            var att = json.properties;
            switch (att.recentspecies) {
                case 'Red-tail Hawk':
                    var radRaptor = 533;
                    break;

                case 'swansons Hawk':
                    var radRaptor = 400;
                    break;
                default:
                    var radRaptor = 804
                    break;
            }

            switch (att.recentstatus) {
                case 'ACTIVE NEST':
                    var optRaptor = { radius: radRaptor, color: 'deeppink', fillColor: 'blue', fillOpacity: 0.5 }
                    break;
                case 'INACTIVE NEST':
                    var optRaptor = { radius: radRaptor, color: 'blue', fillColor: 'blue,fillOpacity:0.5' };
                    break;
                case 'FLEDGED NEST':
                    var optRaptor = { dashArray: "1,8", radius: radRaptor, color: 'deeppink', fillColor: 'blue', fillOpacity: 0.5 }
                    break;

            }
            return L.circle(latlng, optRaptor).bindTooltip("<h4>Raptor Nest: " + att.Nest_ID + "</h4>status:" + att.recentstatus + "<br> Species: " + att.recentspecies + "<br>Last Survey: " + att.lastsurvey)
        }
        function styleClientLine(json) {
            var att = json.properties;
            switch (att.type) {
                case 'pipeline':
                    return { color: 'peru' }
                    break;
                case 'Flowline':
                    return { color: 'navy' }
                    break;
                case 'Flowline,est.':
                    return { color: 'navy', dashArray: [5, 5] }
                    break;
                case 'FElectric Line':
                    return { color: 'darkgreen' }
                    break;
                case 'Access Road - confirmed':
                    return { color: 'darkred' }
                    break;
                case 'Access Road - Estimated':
                    return { color: 'darkred', dashArray: [5, 5] }
                    break;
                case 'Extraction':
                    return { color: 'dindigo' }
                    break;
                default:
                    return { color: 'darkgoldenrod' }
                    break;
            }
        }
        function processClientLinears(json, lyr) {
            var att = json.properties;
            lyr.bindTooltip("<h4>linear project: " + att.Project + "</h4> Type:" + att.type + "<br>Row: " + att.row_width)
        }
        function styleBOUWL(json) {
            var att = json.properties;
            switch (att.hist_occup) {
                case 'Yes':
                    return { color: 'deeppink', fillColor: 'yellow' }
                    break;
                case 'Undetermined':
                    return { color: 'yellow' }
                    break;
            }
        }
        function processBOUWL(json, lyr) {
            var att = json.properties
            lyr.bindTooltip("<h4>Habitat ID: " + att.habitat_id + "</h4> Historically occupied:" + att.hist_occup + "<br>Status: " + att.recentstatus)

        }
        function filterBOUWL(json) {
            var att = json.properties
            if (att.recentstatus == 'REMOVED') {
                return false
            } else {
                return true;
            }
        }

    </script>
</body>

</html>