<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--leaflet-->
    <link rel="stylesheet" href="src/leaflet.css" />
    <script src="src/leaflet.js"></script>

    <link rel="stylesheet" href="src/css/bootstrap.css" />
    <script src="src/jquery-3.2.0.min.js"></script>

    <link rel="stylesheet" href="src/plugins/L.Control.Pan.css" />
    <script src="src/plugins/L.Control.Pan.js"></script>

    <link rel="stylesheet" href="src/plugins/L.Control.Zoomslider.css" />
    <script src="src/plugins/L.Control.Zoomslider.js"></script>

    <link rel="stylesheet" href="src/plugins/L.Control.MousePosition.css" />
    <script src="src/plugins/L.Control.MousePosition.js"></script>

    <link rel="stylesheet" href="src/plugins/Leaflet.PolylineMeasure.css" />
    <script src="src/plugins/Leaflet.PolylineMeasure.js"></script>

    <link rel="stylesheet" href="src/plugins/easy-button.css" />
    <script src="src/plugins/easy-button.js"></script>

    <link rel="stylesheet" href="src/plugins/L.Control.Sidebar.css" />
    <script src="src/plugins/L.Control.Sidebar.js"></script>

    <link rel="stylesheet" href="src/plugins/opencage/src/css/L.Control.OpenCageSearch.css" />
    <script src="src/plugins/opencage/src/js/L.Control.OpenCageSearch.js"></script>

    <link rel="stylesheet" href="src/plugins/leaflet-styleeditor/css/Leaflet.StyleEditor.css" />
    <script src="src/plugins/leaflet-styleeditor/javascript/Leaflet.StyleEditor.js"></script>
    <script src="src/plugins/leaflet-styleeditor/javascript/Leaflet.StyleForms.js"></script>

    <script src="src/plugins/leaflet-providers.js"></script>

    <!--    ***************  Begin Leaflet.Draw-->

    <script src="src/plugins/leaflet-draw/Leaflet.draw.js"></script>
    <script src="src/plugins/leaflet-draw/Leaflet.Draw.Event.js"></script>
    <link rel="stylesheet" href="src/plugins/leaflet-draw/leaflet.draw.css" />

    <script src="src/plugins/leaflet-draw/Toolbar.js"></script>
    <script src="src/plugins/leaflet-draw/Tooltip.js"></script>

    <script src="src/plugins/leaflet-draw/ext/GeometryUtil.js"></script>
    <script src="src/plugins/leaflet-draw/ext/LatLngUtil.js"></script>
    <script src="src/plugins/leaflet-draw/ext/LineUtil.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/ext/Polygon.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/ext/Polyline.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/ext/TouchEvents.js"></script>

    <script src="src/plugins/leaflet-draw/draw/DrawToolbar.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Feature.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.SimpleShape.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Polyline.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Circle.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Marker.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Polygon.js"></script>
    <script src="src/plugins/leaflet-draw/draw/handler/Draw.Rectangle.js"></script>

    <script src="src/plugins/leaflet-draw/edit/EditToolbar.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/EditToolbar.Edit.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/EditToolbar.Delete.js"></script>

    <script src="src/plugins/leaflet-draw/Control.Draw.js"></script>

    <script src="src/plugins/leaflet-draw/edit/handler/Edit.Poly.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/Edit.SimpleShape.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/Edit.Circle.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/Edit.Rectangle.js"></script>
    <script src="src/plugins/leaflet-draw/edit/handler/Edit.Marker.js"></script>

    <!--    **************  End of Lealet Draw-->

    <script src="src/plugins/leaflet.ajax.min.js"></script>
    <!--Leaflet sprite plugin-->
    <script src="src/plugins/leaflet.sprite.js"></script>

    <!-- Font awsome -->
    <link rel="stylesheet" href="src/css/font-awesome.min.css">

    <link rel="stylesheet" href="src/plugins/MarkerCluster.css">
    <link rel="stylesheet" href="src/plugins/MarkerCluster.Default.css">
    <script src="src/plugins/leaflet.markercluster.js"></script>
    <!-- jquery autocomplete -->
    <link rel="stylesheet" href="src/jquery-ui.min.css">
    <script src="src/jquery-ui.min.js"></script>

    <style>
        #mapdiv {
            height: 100vh;
        }

        .col-xs-12,
        .col-xs-6,
        .col-xs-4 {
            padding: 3px;
        }

        #divProject {
            background-color: beige;
        }

        #divBUOWL {
            background-color: #ffffb3;
        }

        #divEagle {
            background-color: #ccffb3;
        }

        #divRaptor {
            background-color: #e6ffff;
        }

        .errorMsg {
            padding: 0;
            text-align: center;
            background-color: darksalmon;
        }
    </style>
</head>

<body>
    <div id="side-bar" class="col-md-3">
        <button id='btnLocate' class='btn btn-primary btn-block'>Locate</button><br>
        <div id="divProject" class="col-xs-12">
            <div id="divProjectLabel" class="text-center col-xs-12">
                <h4 id="lblProject">Linear Projects</h4>
            </div>
            <div id="divProjectError" class="errorMsg col-xs-12"></div>
            <div id="divFindProject" class="form-group has-error">
                <div class="col-xs-6">
                    <input type="text" id="txtFindProject" class="form-control" placeholder="Project ID">
                </div>
                <div class="col-xs-6">
                    <button id="btnFindProject" class="btn btn-primary btn-block" disabled>Find Project</button>
                </div>
            </div>
            <div class="col-xs-12" id="divFilterProject">
                <div class="col-xs-4">
                    <input type="checkbox" name="fltProject" value="Pipeline" checked>pipelines<br>
                    <input type="checkbox" name="fltProject" value="Road" checked>Access Roads
                    <button id="btnProjectFilterAll" class="btn btn-primary btn-block">Check All</button>
                </div>
                <div class="col-xs-4">
                    <input type="checkbox" name="fltProject" value="Electric" checked>Electric Lines<br>
                    <input type="checkbox" name="fltProject" value="Extraction" checked>Extractions
                    <button id="btnProjectFilterNone" class="btn btn-primary btn-block">UnCheck All</button>
                </div>
                <div class="col-xs-4">
                    <input type="checkbox" name="fltProject" value="Flowline" checked>Flowline<br>
                    <input type="checkbox" name="fltProject" value="Other" checked>Other
                    <button id="btnProjectFilter" class="btn btn-primary btn-block">Filter</button>
                </div>
            </div>
            <div class="" id="divProjectData"></div>
        </div>
        <div id="divBUOWL" class="col-xs-12">
            <div id="divBUOWLLabel" class="text-center col-xs-12">
                <h4 id="lblBUOWL">BUOWL Habitat</h4>
            </div>
            <div id="divBUOWLError" class="errorMsg col-xs-12"></div>
            <div id="divFindBUOWL" class="form-group has-error">
                <div class="col-xs-6">
                    <input type="text" id="txtFindBUOWL" class="form-control" placeholder="Habitat ID">
                </div>
                <div class="col-xs-6">
                    <button id="btnFindBUOWL" class="btn btn-primary btn-block" disabled>Find BUOWL</button>
                </div>
            </div>
            <div id="divFilterBUOWL" class="col-xs-12">
                <div class="col-xs-4">
                    <input type='radio' name='fltBUOWL' value='ALL' checked>All
                </div>
                <div class="col-xs-4">
                    <input type='radio' name='fltBUOWL' value='Yes'>Historically Occupied
                </div>
                <div class="col-xs-4">
                    <input type='radio' name='fltBUOWL' value='Undetermined'>Undetermined
                </div>
            </div>
            <div class="" id="divBUOWLData"></div>
        </div>
        <div id="divEagle" class="col-xs-12">
            <div id="divEagleLabel" class="text-center col-xs-12">
                <h4 id="lblEagle">Eagle Nests</h4>
            </div>
            <div id="divEagleError" class="errorMsg col-xs-12"></div>
            <div id="divFindEagle" class="form-group has-error">
                <div class="col-xs-6">
                    <input type="text" id="txtFindEagle" class="form-control" placeholder="Eagle Nest ID">
                </div>
                <div class="col-xs-6">
                    <button id="btnFindEagle" class="btn btn-primary btn-block" disabled>Find Eagle Nest</button>
                </div>
            </div>
            <div id="divFilterEagle" class="col-xs-12">
                <div class="col-xs-4">
                    <input type='radio' name='fltEagle' value='ALL' checked>All
                </div>
                <div class="col-xs-4">
                    <input type='radio' name='fltEagle' value='ACTIVE NEST'>Active
                </div>
                <div class="col-xs-4">
                    <input type='radio' name='fltEagle' value='INACTIVE LOCATION'>Inactive
                </div>
            </div>
            <div class="" id="divEagleData"></div>
        </div>
        <div id="divRaptor" class="col-xs-12">
            <div id="divRaptorLabel" class="text-center col-xs-12">
                <h4 id="lblRaptor">Raptor Nests</h4>
            </div>
            <div id="divRaptorError" class="errorMsg col-xs-12"></div>
            <div id="divFindRaptor" class="form-group has-error">
                <div class="col-xs-6">
                    <input type="text" id="txtFindRaptor" class="form-control" placeholder="Raptor Nest ID">
                </div>
                <div class="col-xs-6">
                    <button id="btnFindRaptor" class="btn btn-primary btn-block" disabled>Find Raptor Nest</button>
                </div>
            </div>
            <div id="divFilterRaptor" class="col-xs-12">
                <div class="col-xs-3">
                    <input type='radio' name='fltRaptor' value='ALL' checked>All
                </div>
                <div class="col-xs-3">
                    <input type='radio' name='fltRaptor' value='ACTIVE NEST'>Active
                </div>
                <div class="col-xs-3">
                    <input type='radio' name='fltRaptor' value='INACTIVE NEST'>Inactive
                </div>
                <div class="col-xs-3">
                    <input type='radio' name='fltRaptor' value='FLEDGED NEST'>Fledged
                </div>
            </div>
            <div class="" id="divRaptorData"></div>
        </div>
    </div>
    <div id="mapdiv" class="col-md-12"></div>
    <script>
        var mymap;
        var lyrOSM;
        var lyrWatercolor;
        var lyrTopo;
        var lyrImagery;
        var lyrOutdoors;
        var lyrEagleNests;
        var lyrRaptorNests;
        var lyrClientLines;
        var lyrBUOWL;
        var lyrGBH;
        var lyrSearch;
        var lyrMarkerCluster;
        var mrkCurrentLocation;
        var fgpDrawnItems;
        var ctlAttribute;
        var ctlScale;
        var ctlMouseposition;
        var ctlMeasure;
        var ctlEasybutton;
        var ctlSidebar;
        var ctlLayers;
        var ctlDraw;
        var ctlStyle;
        var objBasemaps;
        var objOverlays;
        var arProjectIDs = [];
        var arHabitatIDs = [];
        var arEagleIDs = [];
        var arRaptorIDs = [];

        $(document).ready(function () {

            //  ********* Map Initialization ****************

            mymap = L.map('mapdiv', { center: [40.18, -104.83], zoom: 11, attributionControl: false });

            ctlSidebar = L.control.sidebar('side-bar').addTo(mymap);

            ctlEasybutton = L.easyButton("glyphicon-triangle-right", function () {
                ctlSidebar.show();
            }).addTo(mymap);

            ctlEasybutton = L.easyButton("glyphicon-triangle-left", function () {
                ctlSidebar.hide();
            }).addTo(mymap);
            ctlAttribute = L.control.attribution().addTo(mymap);
            ctlAttribute.addAttribution('OSM');
            ctlAttribute.addAttribution(
                '&copy; <a href="http://servdev.co.ke">servdev Solutions</a>'
            );
            ctlScale = L.control.scale({ position: 'bottomleft', metric: false, maxWidth: 200 }).addTo(mymap);

            ctlMouseposition = L.control.mousePosition().addTo(mymap);

            ctlStyle = L.control.styleEditor({ position: 'topright' }).addTo(mymap);
            ctlMeasure = L.control.polylineMeasure().addTo(mymap);

            //   *********** Layer Initialization **********

            lyrOSM = L.tileLayer.provider('OpenStreetMap.Mapnik');
            lyrTopo = L.tileLayer.provider('OpenTopoMap');
            lyrImagery = L.tileLayer.provider('Esri.WorldImagery');
            lyrOutdoors = L.tileLayer.provider('Thunderforest.Outdoors');
            lyrWatercolor = L.tileLayer.provider('Stamen.Watercolor');
            mymap.addLayer(lyrOSM);

            fgpDrawnItems = new L.FeatureGroup();
            fgpDrawnItems.addTo(mymap);

            lyrEagleNests = L.geoJSON.ajax('data/wildlife_eagle.geojson',
                { pointToLayer: returnEagleMarker, filter: filterEagle }).addTo(mymap);
            lyrEagleNests.on('data:loaded', function () {
                arEagleIDs.sort(function (a, b) { return a - b });
                $("#txtFindEagle").autocomplete({
                    source: arEagleIDs
                });
            });

            lyrMarkerCluster = L.markerClusterGroup();
            lyrRaptorNests = L.geoJSON.ajax('data/wildlife_raptor.geojson', { pointToLayer: returnRaptorMarker, filter: filterRaptor });
            lyrRaptorNests.on('data:loaded', function () {
                arRaptorIDs.sort(function (a, b) { return a - b });
                $("#txtFindRaptor").autocomplete({
                    source: arRaptorIDs
                });
                lyrMarkerCluster.clearLayers();
                lyrMarkerCluster.addLayer(lyrRaptorNests);
                lyrMarkerCluster.addTo(mymap);
            });

            lyrClientLines = L.geoJSON.ajax('data/client_lines.geojson', { style: styleClientLinears, onEachFeature: processClientLinears, filter: filterClientLines }).addTo(mymap);
            lyrClientLines.on('data:loaded', function () {
                arProjectIDs.sort(function (a, b) { return a - b });
                $("#txtFindProject").autocomplete({
                    source: arProjectIDs
                });
            });

            lyrBUOWL = L.geoJSON.ajax('data/wildlife_buowl.geojson', { style: styleBUOWL, onEachFeature: processBUOWL, filter: filterBUOWL }).addTo(mymap);
            lyrBUOWL.on('data:loaded', function () {
                arHabitatIDs.sort(function (a, b) { return a - b });
                $("#txtFindBUOWL").autocomplete({
                    source: arHabitatIDs
                });
            });

            lyrGBH = L.geoJSON.ajax('data/wildlife_gbh.geojson', { style: { color: 'fuchsia' } }).bindTooltip("GBH Nesting Area").addTo(mymap);

            // ********* Setup Layer Control  ***************

            objBasemaps = {
                "Open Street Maps": lyrOSM,
                "Topo Map": lyrTopo,
                "Imagery": lyrImagery,
                "Outdoors": lyrOutdoors,
                "Watercolor": lyrWatercolor
            };

            objOverlays = {
                "Client Linears": lyrClientLines,
                "Burrowing Owl Habitat": lyrBUOWL,
                "Eagle Nest": lyrEagleNests,
                "Raptor Nest": lyrMarkerCluster,
                "GBH Rookeries": lyrGBH,
                "Drawn Items": fgpDrawnItems
            };

            ctlLayers = L.control.layers(objBasemaps, objOverlays).addTo(mymap);

            // **********  Setup Draw Control ****************

            ctlDraw = new L.Control.Draw({
                draw: {
                    circle: true,
                    rectangle: true,
                },
                edit: {
                    featureGroup: fgpDrawnItems
                }
            });
            ctlDraw.addTo(mymap);

            mymap.on('draw:created', function (e) {
                fgpDrawnItems.addLayer(e.layer);
            });

            // ************ Location Events **************

            mymap.on('locationfound', function (e) {
                console.log(e);
                if (mrkCurrentLocation) {
                    mrkCurrentLocation.remove();
                }
                mrkCurrentLocation = L.circle(e.latlng, { radius: e.accuracy / 2 }).addTo(mymap);
                mymap.setView(e.latlng, 14);
            });

            mymap.on('locationerror', function (e) {
                console.log(e);
                alert("Location was not found");
            })

        });

        //  ********* BUOWL Functions

        function styleBUOWL(json) {
            var att = json.properties;
            switch (att.hist_occup) {
                case 'Yes':
                    return { color: 'deeppink', fillColor: 'yellow' };
                    break;
                case 'Undetermined':
                    return { color: 'yellow' };
                    break;
            }
        }

        function processBUOWL(json, lyr) {
            var att = json.properties;
            lyr.bindTooltip("<h4>Habitat ID: " + att.habitat_id + "</h4>Historically Occupied: " + att.hist_occup + "<br>Status: " + att.recentstatus);
            arHabitatIDs.push(att.habitat_id.toString())
        }

        function filterBUOWL(json) {
            var att = json.properties;
            if (att.recentstatus == 'REMOVED') {
                return false;
            } else {
                var optFilter = $("input[name=fltBUOWL]:checked").val();
                if (optFilter == 'ALL') {
                    return true;
                } else {
                    return (att.hist_occup == optFilter);
                }
            }
        }

        $("#txtFindBUOWL").on('keyup paste', function () {
            var val = $("#txtFindBUOWL").val();
            testLayerAttribute(arHabitatIDs, val, "Habitat ID", "#divFindBUOWL", "#divBUOWLError", "#btnFindBUOWL");
        });

        $("#btnFindBUOWL").click(function () {
            var val = $("#txtFindBUOWL").val();
            var lyr = returnLayerByAttribute(lyrBUOWL, 'habitat_id', val);
            if (lyr) {
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                lyrSearch = L.geoJSON(lyr.toGeoJSON(), { style: { color: 'red', weight: 10, opacity: 0.5, fillOpacity: 0 } }).addTo(mymap);
                mymap.fitBounds(lyr.getBounds().pad(1));
                var att = lyr.feature.properties;
                $("#divBUOWLData").html("<h4 class='text-center'>Attributes</h4><h5>Habitat: " + att.habitat + "</h5><h5>Historically Occupied: " + att.hist_occup + "</h5><h5>Recent Status: " + att.recentstatus + "</h5>");
                $("#divBUOWLError").html("");
                fgpDrawnItems.clearLayers();
                fgpDrawnItems.addLayer(lyr);
            } else {
                $("#divBUOWLError").html("**** Habitat ID not found ****");
            }
        });

        $("#lblBUOWL").click(function () {
            $("#divBUOWLData").toggle();
        });

        $("input[name=fltBUOWL]").click(function () {
            arHabitatIDs = [];
            lyrBUOWL.refresh();
        });

        // ************ Client Linears **********

        function styleClientLinears(json) {
            var att = json.properties;
            switch (att.type) {
                case 'Pipeline':
                    return { color: 'peru' };
                    break;
                case 'Flowline':
                    return { color: 'navy' };
                    break;
                case 'Flowline, est.':
                    return { color: 'navy', dashArray: "5,5" };
                    break;
                case 'Electric Line':
                    return { color: 'darkgreen' };
                    break;
                case 'Access Road - Confirmed':
                    return { color: 'darkred' };
                    break;
                case 'Access Road - Estimated':
                    return { color: 'darkred', dashArray: "5,5" };
                    break;
                case 'Extraction':
                    return { color: 'indigo' };
                    break;
                default:
                    return { color: 'darkgoldenrod' }
            }
        }

        function processClientLinears(json, lyr) {
            var att = json.properties;
            lyr.bindTooltip("<h4>Linear Project: " + att.Project + "</h4>Type: " + att.type + "<br>ROW Width: " + att.row_width);
            arProjectIDs.push(att.Project.toString());
        }
        function filterClientLines(json) {
            var arProjectFilters = [];
            $("input[name=fltProject]").each(function () {
                if (this.checked) {
                    arProjectFilters.push(this.value)
                }
            });
            var att = json.properties;
            switch (att.type) {
                case "Pipeline":
                    return (arProjectFilters.indexOf("Pipeline") >= 0)
                    break;
                case "Flowline":
                    return (arProjectFilters.indexOf("Flowline") >= 0)
                    break;
                case "Flowline,est.":
                    return (arProjectFilters.indexOf("Flowline") >= 0)
                    break;
                case "Electrical Line":
                    return (arProjectFilters.indexOf("Electric") >= 0)
                    break;
                case "Access Road - Confirmed":
                    return (arProjectFilters.indexOf("Road") >= 0)
                    break;
                case "Access Road - Estimated":
                    return (arProjectFilters.indexOf("Road") >= 0)
                    break;
                case "Extraction":
                    return (arProjectFilters.indexOf("Extraction") >= 0)
                    break;
                default:
                    return (arProjectFilters.indexOf("Other") >= 0)
                    break;
            }
        }

        $("#txtFindProject").on('keyup paste', function () {
            var val = $("#txtFindProject").val();
            testLayerAttribute(arProjectIDs, val, "PROJECT ID", "#divFindProject", "#divProjectError", "#btnFindProject");
        });

        $("#btnFindProject").click(function () {
            var val = $("#txtFindProject").val();
            var lyr = returnLayerByAttribute(lyrClientLines, 'Project', val);
            if (lyr) {
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                lyrSearch = L.geoJSON(lyr.toGeoJSON(), { style: { color: 'red', weight: 10, opacity: 0.5 } }).addTo(mymap);
                mymap.fitBounds(lyr.getBounds().pad(1));
                var att = lyr.feature.properties;
                $("#divProjectData").html("<h4 class='text-center'>Attributes</h4><h5>Type: " + att.type + "</h5><h5>ROW width: " + att.row_width + "m </h5>");
                $("#divProjectError").html("");
                fgpDrawnItems.clearLayers();
                fgpDrawnItems.addLayer(lyr);
            } else {
                $("#divProjectError").html("**** Project ID not found ****");
            }
        });

        $("#lblProject").click(function () {
            $("#divProjectData").toggle();
        });
        $("#btnProjectFilterAll").click(function () {
            $("input[name=fltProject]").prop('checked', true)
        });
        $("#btnProjectFilterNone").click(function () {
            $("input[name=fltProject]").prop('checked', false)
        });
        $("#btnProjectFilter").click(function () {
            arProjectIDS = [];
            lyrClientLines.refresh();

        })

        // *********  Eagle Functions *****************

        function returnEagleMarker(json, latlng) {
            var att = json.properties;
            if (att.status == 'ACTIVE NEST') {
                var clrNest = 'deeppink';
            } else {
                var clrNest = 'chartreuse';
            }
            arEagleIDs.push(att.nest_id.toString());
            return L.circle(latlng, { radius: 804, color: clrNest, fillColor: 'chartreuse', fillOpacity: 0.5 }).bindTooltip("<h4>Eagle Nest: " + att.nest_id + "</h4>Status: " + att.status);
        }

        function filterEagle(json) {
            var att = json.properties;
            var optFilter = $("input[name=fltEagle]:checked").val();
            if (optFilter == 'ALL') {
                return true;
            } else {
                return (att.status == optFilter);
            }
        }

        $("#txtFindEagle").on('keyup paste', function () {
            var val = $("#txtFindEagle").val();
            testLayerAttribute(arEagleIDs, val, "Eagle Nest ID", "#divFindEagle", "#divEagleError", "#btnFindEagle");
        });

        $("#btnFindEagle").click(function () {
            var val = $("#txtFindEagle").val();
            var lyr = returnLayerByAttribute(lyrEagleNests, 'nest_id', val);
            if (lyr) {
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                lyrSearch = L.circle(lyr.getLatLng(), { radius: 800, color: 'red', weight: 10, opacity: 0.5, fillOpacity: 0 }).addTo(mymap);
                mymap.setView(lyr.getLatLng(), 14);
                var att = lyr.feature.properties;
                $("#divEagleData").html("<h4 class='text-center'>Attributes</h4><h5>Status: " + att.status + "</h5>");
                $("#divEagleError").html("");
                fgpDrawnItems.clearLayers();
                fgpDrawnItems.addLayer(lyr);
            } else {
                $("#divEagleError").html("**** Eagle Nest ID not found ****");
            }
        });

        $("#lblEagle").click(function () {
            $("#divEagleData").toggle();
        });

        $("input[name=fltEagle]").click(function () {
            arEagleIDs = [];
            lyrEagleNests.refresh();
        });

        //  *********** Raptor Functions

        function returnRaptorMarker(json, latlng) {
            var att = json.properties;
            arRaptorIDs.push(att.Nest_ID.toString());
            switch (att.recentspecies) {
                case 'Red-tail Hawk':
                    var radRaptor = 533;
                    break;
                case 'Swainsons Hawk':
                    var radRaptor = 400;
                    break;
                default:
                    var radRaptor = 804;
                    break;
            }
            switch (att.recentstatus) {
                case 'ACTIVE NEST':
                    var optRaptor = { radius: radRaptor, color: 'deeppink', fillColor: "cyan", fillOpacity: 0.5 };
                    break;
                case 'INACTIVE NEST':
                    var optRaptor = { radius: radRaptor, color: 'cyan', fillColor: 'cyan', fillOpacity: 0.5 };
                    break;
                case 'FLEDGED NEST':
                    var optRaptor = { radius: radRaptor, color: 'deeppink', fillColor: "cyan", fillOpacity: 0.5, dashArray: "2,8" };
                    break;
            }
            return L.circle(latlng, optRaptor).bindPopup("<h4>Raptor Nest: " + att.Nest_ID + "</h4>Status: " + att.recentstatus + "<br>Species: " + att.recentspecies + "<br>Last Survey: " + att.lastsurvey);
        }

        function filterRaptor(json) {
            var att = json.properties;
            var optFilter = $("input[name=fltRaptor]:checked").val();
            if (optFilter == 'ALL') {
                return true;
            } else {
                return (att.recentstatus == optFilter);
            }
        }

        $("#txtFindRaptor").on('keyup paste', function () {
            var val = $("#txtFindRaptor").val();
            testLayerAttribute(arRaptorIDs, val, "Raptor Nest ID", "#divFindRaptor", "#divRaptorError", "#btnFindRaptor");
        });

        $("#btnFindRaptor").click(function () {
            var val = $("#txtFindRaptor").val();
            var lyr = returnLayerByAttribute(lyrRaptorNests, 'Nest_ID', val);
            if (lyr) {
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                var att = lyr.feature.properties;
                switch (att.recentspecies) {
                    case 'Red-tail Hawk':
                        var radRaptor = 533;
                        break;
                    case 'Swainsons Hawk':
                        var radRaptor = 400;
                        break;
                    default:
                        var radRaptor = 804;
                        break;
                }
                lyrSearch = L.circle(lyr.getLatLng(), { radius: radRaptor, color: 'red', weight: 10, opacity: 0.5, fillOpacity: 0 }).addTo(mymap);
                mymap.setView(lyr.getLatLng(), 14);
                $("#divRaptorData").html("<h4 class='text-center'>Attributes</h4><h5>Status: " + att.recentstatus + "</h5><h5>Species: " + att.recentspecies + "</h5><h5>Last Survey: " + att.lastsurvey + "</h5>");
                $("#divRaptorError").html("");
                fgpDrawnItems.clearLayers();
                fgpDrawnItems.addLayer(lyr);
            } else {
                $("#divRaptorError").html("**** Raptor Nest ID not found ****");
            }
        });

        $("#lblRaptor").click(function () {
            $("#divRaptorData").toggle();
        });

        $("input[name=fltRaptor]").click(function () {
            arRaptorIDsIDs = [];
            lyrRaptorNests.refresh();
        });

        //  *********  jQuery Event Handlers  ************

        $("#btnLocate").click(function () {
            mymap.locate();
        });

        //  ***********  General Functions *********

        function LatLngToArrayString(ll) {
            return "[" + ll.lat.toFixed(5) + ", " + ll.lng.toFixed(5) + "]";
        }

        function returnLayerByAttribute(lyr, att, val) {
            var arLayers = lyr.getLayers();
            for (i = 0; i < arLayers.length - 1; i++) {
                var ftrVal = arLayers[i].feature.properties[att];
                if (ftrVal == val) {
                    return arLayers[i];
                }
            }
            return false;
        }

        function testLayerAttribute(ar, val, att, fg, err, btn) {
            if (ar.indexOf(val) < 0) {
                $(fg).addClass("has-error");
                $(err).html("**** " + att + " NOT FOUND ****");
                $(btn).attr("disabled", true);
            } else {
                $(fg).removeClass("has-error");
                $(err).html("");
                $(btn).attr("disabled", false);
            }
        }



    </script>
</body>

</html>